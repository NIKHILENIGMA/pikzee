---
title: Authentication 
description: How login feature works
category: "Features"
---

## Login

### üè∑Ô∏è Overview

**Feature Name:** User Login Flow
**Module/Scope:** Authentication
**Author:** Nikhil Harmalkar
**Last Updated:** `2025-11-02`
**Status:** `Completed`

**Short Summary:**

Login via Clerk

- Frontend: Integrate Clerk React SDK and render Clerk's `<SignIn/>` (or useSignIn/useUser hooks) inside ClerkProvider (CLERK_FRONTEND_API). After successful sign-in Clerk manages the session and exposes the authenticated user via useUser.

- Backend: Protect APIs by verifying Clerk sessions with @clerk/nextjs or @clerk/clerk-sdk-node (requireAuth / withAuth / verifyToken). Use clerkUserId from the verified session to upsert a local user record on first login.

- Environment: CLERK_FRONTEND_API, CLERK_SECRET_KEY.

- Notes: Rely on Clerk for authentication, session lifecycle, and provider/OAuth handling; backend should only accept requests with a verified Clerk session.

---

### üéØ Feature Goals & Requirements

**Business Goals**

- Clear description of the user/business value this feature provides.

**Technical Goals**

- Define what this feature achieves technically.
- Example: ‚ÄúSyncs invitation acceptance with Clerk user creation flow.‚Äù

**Non-Goals**

- (Optional) Clarify what the feature doesn‚Äôt handle (to avoid confusion later).

---

### ‚öôÔ∏è High-Level Flow

> Quick bullet sequence of how the feature works from frontend ‚Üí backend ‚Üí database.

```
Frontend ‚Üí API ‚Üí Backend Service ‚Üí Database ‚Üí Response ‚Üí UI Update
```

**Example**

1. User clicks "Invite Member" ‚Üí triggers modal with email & role input.
2. Frontend calls `/api/workspaces/:id/invite` via Axios.
3. Backend validates request ‚Üí creates invitation record ‚Üí sends email via Resend.
4. Invitee clicks email link ‚Üí frontend calls `/api/invitations/accept`.
5. Backend validates token ‚Üí adds member to workspace ‚Üí deletes invitation record.
6. Frontend redirects to workspace dashboard with success banner.

---

### üß† Architecture Flow Diagram (Sequence)

Use PlantUML / Mermaid / or Zudoku‚Äôs built-in diagram block:

```mermaid
sequenceDiagram
    participant U as User (Frontend)
    participant FE as Next.js Frontend
    participant BE as NestJS Backend
    participant DB as PostgreSQL
    participant EM as Email Service (Resend)

    U->>FE: Click Invite Member
    FE->>BE: POST /api/workspaces/:id/invite
    BE->>DB: INSERT INTO invitations (...)
    BE->>EM: Send Invitation Email
    EM-->>U: Invitation Email with token link
    U->>FE: Click Accept Invitation
    FE->>BE: POST /api/invitations/accept
    BE->>DB: Verify + Update workspace_members
    BE-->>FE: 200 OK
    FE-->>U: Show Success UI
```

---

### üíª Frontend Implementation

**Location:**
`/src/features/workspaces/invite/InviteModal.tsx`
`/src/api/invite.api.ts`

**Key Hooks / Components**

- `useInviteMemberMutation`
- `InviteMemberForm`
- `ModalProvider`

**Key Libraries**

- `react-hook-form`, `zod`, `axios`, `tanstack-query`

**Flow**

1. Form validation using Zod schema
2. Call `POST /api/workspaces/:id/invite` mutation
3. On success ‚Üí show toast & invalidate query `workspaceMembers`

**Example Pseudo:**

```tsx
const mutation = useMutation({
  mutationFn: inviteMemberApi,
  onSuccess: () => queryClient.invalidateQueries(workspaceKeys.members()),
});
```

---

### üß∞ Backend Implementation

**Location:**
`/src/modules/invitations/invitations.controller.ts`
`/src/modules/invitations/invitations.service.ts`

**Key Endpoints**

- `POST /api/workspaces/:id/invite` ‚Üí `createInvitation()`
- `POST /api/invitations/accept` ‚Üí `acceptInvitation()`

**Key Functions**

- `generateInvitationToken()`
- `validateInvitationToken()`
- `addMemberToWorkspace()`

**Middleware**

- `authenticateUser`
- `attachWorkspaceContext`

**Logic Summary**

- Validate permissions ‚Üí only admins can invite
- Store invitation in `workspace_invitations`
- Use Resend API for email
- On acceptance, validate token & add to `workspace_members`

---

### üßæ Database Schema (Drizzle / Prisma)

```sql
CREATE TABLE workspace_invitations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  email VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL,
  token VARCHAR(255) UNIQUE NOT NULL,
  expires_at TIMESTAMP NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Relations**

- `workspace_invitations.workspace_id ‚Üí workspaces.id`
- After acceptance ‚Üí `workspace_members.user_id ‚Üí users.id`

---

### üß™ Testing Notes

**Manual Testing**

- Test invite email received
- Expired token case
- Re-inviting an existing member

**Postman Collection:**
`/docs/postman/workspace-invitations.postman.json`

**Automated Tests**

- `invitations.service.spec.ts`
- `invitations.controller.spec.ts`

---

### üì° CI/CD & Deployment Notes

- Feature flag (if any)
- Environment variables used:

  ```
  RESEND_API_KEY=
  INVITE_TOKEN_SECRET=
  INVITE_TOKEN_EXPIRY=24h
  ```

- Migration path:

  - Run `pnpm drizzle:push` before deploying backend.

---

### üß≠ Future Enhancements

- Add bulk invitations
- Add analytics for pending invites
- Add retry email for failed deliveries

---

### üìö References

- [Clerk Docs ‚Äì Organizations](https://clerk.com/docs/organizations)
- [Resend API ‚Äì Send Email](https://resend.com/docs/api-reference/emails/send)
- Internal Slack Thread: `#workspace-invitation-flow`

---

## ‚úÖ Template Reusability Guide

When documenting new features, **duplicate this file** and just modify:

- Overview section (feature name, summary)
- Frontend, Backend, DB details
- Mermaid diagram
- CI/CD variables
- Future roadmap

---

Would you like me to format this into a **ready-to-use Zudoku `.mdx` documentation page structure** (with Tailwind classes, sections, and Zudoku syntax for collapsibles and diagrams)?
That way, you can copy‚Äìpaste it directly into your `/docs/features/` folder.
